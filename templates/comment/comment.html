<!-- comments.html -->
{% extends "base.html" %}

{% block content %}
  <h1>Comments</h1>
  
  <form method="post">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button type="submit">Post Comment</button>
  </form>

  <!-- Movie Filtering Form -->
  <h2>Filter Comments by Movie</h2>
  <form method="get">
    {{ filter_form.as_p }}
    <button type="submit">Filter</button>
  </form>


  <h2>All Comments</h2>
  <ul>
    {% for comment in comments %}
      <li>
        <strong><a href="{% url 'movie:movie_detail' comment.movie_name %}">{{ comment.movie_name }}</a></strong><br>
        <img src="{{ comment.imagepath }}" alt="" style="width: 100px;"><br>
        by {{ comment.user }} on {{ comment.date }}<br>
        評価: {{ comment.get_rating_display }}<br>
        {{ comment.comment }}<br>
        <button class="like-btn" data-id="{{ comment.id }}">Like</button>
        <span id="likes-{{ comment.id }}">{{ comment.likes }}</span> likes
      </li>
    {% endfor %}
  </ul>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function(){
      $('.like-btn').click(function(){
        var commentId = $(this).data('id');
        var url = "{% url 'comment:like_comment' comment_id=0 %}".replace('0', commentId);
        console.log(url);
        $.ajax({
          url: url,
          method: 'POST',
          data: {
            'csrfmiddlewaretoken': '{{ csrf_token }}'
          },
          success: function(response) {
            $('#likes-' + commentId).text(response.likes);
          }
        });
      });
    });
  </script>

{% endblock %}
